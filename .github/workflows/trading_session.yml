name: Trading Session

on:
  schedule:
    # US Market Open: 9:30 AM ET -> 14:30 UTC
    - cron: '30 14 * * 1-5'
    # US Market Close: 4:00 PM ET -> 21:00 UTC
    - cron: '0 21 * * 1-5'
  workflow_dispatch:
    inputs:
      session:
        description: 'Session to run (OPEN/CLOSE)'
        required: true
        default: 'OPEN'
        type: choice
        options:
          - OPEN
          - CLOSE

jobs:
  trade:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to push database changes back to repo
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install .

      - name: Run Trading Session
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          # Add other API keys here as secrets in GitHub
        run: |
          # Determine session type
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            SESSION="${{ github.event.inputs.session }}"
          else
            # For scheduled runs, determine based on hour (UTC)
            HOUR=$(date +%H)
            if [ "$HOUR" -ge 18 ]; then
              SESSION="CLOSE"
            else
              SESSION="OPEN"
            fi
          fi
          
          echo "Running $SESSION session..."
          python -m myllmtradingagents.cli run --config config/arena.yaml --session $SESSION

      - name: Commit and Push Database Changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if arena.db exists and has changed
          if [ -f "arena.db" ]; then
            git add arena.db
            if git diff --staged --quiet; then
              echo "No changes to database."
            else
              git commit -m "chore: update arena.db [skip ci]"
              git push
            fi
          else
            echo "arena.db not found."
          fi
